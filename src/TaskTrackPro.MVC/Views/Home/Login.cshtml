@{
    Layout="_AuthLayout";
}

<div class="login-bg-wrapper d-flex flex-column">
    <div class="login-logo-header d-flex align-items-center bg-danger">
        <a href="#" class="login-logo-wrapper">
            <img src="~/css/Default/images/LogoImage.png" class="login-logo-img" alt="TaskTrackPro" />
        </a>
        <span class="separator"></span>
        <span class="login-branh-text">TaskTrackPro</span>
    </div>
    <div class="login-graphic-wrapper flex-1 overflow-auto d-flex flex-wrap">
        <div class="login-left-wrapper">
            <div>
                <img src="~/css/Default/images/Login_Graphics.svg" alt="TaskTrackPro" class="login-graphice-img" />
                <p class="login-graphice-text">Keep Your Agile Ceremonies Effective and provide a seamless cycle of
                    successful sprints</p>
            </div>
        </div>
        <div class="login-right-wrapper">
            <div class="loginpage-box-wrapper">
                <h2 class="login-title text-dark font-bold">Sign In</h2>
                <form class="loginpage-box-content" id="loginForm">
                    <div class="form-group">
                        <div class="custom-dropdown">
                            <select name="role" id="role" class="form-control">
                                <option value="Admin">Admin</option>
                                <option value="User">User</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <input type="email" class="k-textbox login-textbox" placeholder="Email" id="loginEmail"
                            name="loginEmail" required>
                        <span class="login-textbox-icon"><i class="icon-email"></i></span>
                    </div>
                    <div class="form-group">
                        <input type="password" class="k-textbox login-textbox" placeholder="Password" id="loginPassword"
                            name="loginPassword" required>
                        <span class="login-textbox-icon"><i class="icon-locked"></i></span>
                    </div>
                    <div class="form-group pb-10">
                        <button type="submit" class="btn btn-primary k-button w100 loginbtn" id="submit">Log In</button>
                    </div>
                    <p id="message" class="text-center text-danger"></p>
                    <div class="text-center">
                        <span class="text-dark font-medium">Don't Have an account?</span>
                        <a asp-action="Register"
                            class="forgot-pwd btn-link-trans font-medium text-dark text-primary">Register here</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Load Necessary Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<!--  Fix Validation Issue -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script> <!--  SignalR -->

<script>
    $(document).ready(function () {
        console.log($.fn.validate ? " jQuery Validation is loaded" : " jQuery Validation is missing!");

        // jQuery Validation
        $("#loginForm").validate({
            rules: {
                loginEmail: { required: true, email: true },
                loginPassword: { required: true }
            },
            messages: {
                loginEmail: { required: "Email is required", email: "Enter a valid email" },
                loginPassword: { required: "Password is required" }
            },
            submitHandler: function (form) {
                loginUser(); // Call login function when form is valid
            }
        });

        function loginUser() {
            var email = $("#loginEmail").val();
            var password = $("#loginPassword").val();
            var role = $("#role").val();
            var formData = new FormData();
            formData.append("c_email", email);
            formData.append("c_password", password);
            formData.append("c_role", role)
            $.ajax({
                url: "http://localhost:5136/api/UserApi/Login", // API Endpoint
                type: "POST",
                processData: false,
                contentType: false,
                data: formData,
                success: function (response) {
                        var userdata = JSON.stringify(response.data)
                    if (response.success) {
                        sessionStorage.setItem("userEmail", email); //  Store email for SignalR chat
                        $("#message").text(response.message).css("color", "green");

                        // Connect to SignalR after successful login
                        connectToSignalR(email);
                        if (response.role == "Admin") {
                            window.location.href = "/Admin/Index"
                        }
                        else {
                            window.location.href = "/User/Task"
                            sessionStorage.setItem("User",userdata)
                        }
                    } 
                    else {
                        $("#message").text(response.message).css("color", "green");
                    }
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                    $("#message").text("Invalid Credentials!").css("color", "red");
                }
            });
        }

        function connectToSignalR(userEmail) {
            let connection = new signalR.HubConnectionBuilder()
                .withUrl("http://localhost:5136/chatHub") //  ChatHub URL
                .configureLogging(signalR.LogLevel.Information)
                .build();

            // Handle real-time messages
            connection.on("ReceiveMessage", function (sender, message) {
                console.log("New message from " + sender + ": " + message);
                alert("New message from " + sender + ": " + message); // Replace with chat UI update
            });

            // Start the connection
            connection.start()
                .then(function () {
                    console.log("Connected to SignalR as " + userEmail);
                })
                .catch(function (err) {
                    console.error("SignalR connection error: ", err);
                });
        }
    });
</script>